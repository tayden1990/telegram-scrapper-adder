<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Scrape</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .nav a { margin-right: 1rem; }
    textarea { width: 100%; height: 200px; }
    input[type=text], input[type=number] { width: 420px; padding: 6px; }
  </style>
</head>
<body>
  <div class="nav">
    <a href="/">Dashboard</a>
  <a href="/admin/accounts">Accounts</a>
    <a href="/upload">Upload</a>
    <a href="/scrape"><b>Scrape</b></a>
    <a href="/settings">Settings</a>
  </div>
  <h1>Scrape Members</h1>
  <form method="post" action="/scrape/run">
    <input type="hidden" name="csrf" value="{{ csrf }}" />
    <p><label>Source (group/channel username or link)
      <input type="text" name="source" value="{{ source or '' }}" required />
    </label></p>
    <p><label>Limit <input type="number" name="limit" value="{{ limit or 500 }}" /></label></p>
    <p><label>Query contains <input type="text" name="query" value="{{ query or '' }}" /></label></p>
    <p><label>Min last seen (days) <input type="number" name="min_last_seen_days" value="{{ min_last_seen_days or '' }}" /></label></p>
    <p><label>Exclude if contains (comma-separated)
      <input type="text" name="exclude_contains" value="{{ exclude_contains or '' }}" />
    </label></p>
    <p>
      <label><input type="checkbox" name="include_full" value="1" {% if include_full %}checked{% endif %}/> Include full profile (bio/common chats)</label><br/>
      <label><input type="checkbox" name="skip_bots" value="1" {% if skip_bots is not defined or skip_bots %}checked{% endif %}/> Skip bots</label>
      <label style="margin-left:1rem;"><input type="checkbox" name="skip_admins" value="1" {% if skip_admins is not defined or skip_admins %}checked{% endif %}/> Skip admins</label>
    </p>
    <button type="submit">Run</button>
  </form>

  {% if results is not none %}
  <h2>Results ({{ results|length }})</h2>
  {% if include_full %}
  <p class="muted">Previewing first 10 detailed rows:</p>
  <pre style="max-height:220px; overflow:auto; background:#f8f8f8; padding:8px;">{{ results[:10] | tojson(indent=2) }}</pre>
  {% endif %}
  <form method="post" action="/scrape/export" style="margin-bottom:1rem;">
    <input type="hidden" name="csrf" value="{{ csrf }}" />
    <input type="hidden" name="source" value="{{ source }}" />
    <input type="hidden" name="limit" value="{{ limit }}" />
    <input type="hidden" name="query" value="{{ query }}" />
    <input type="hidden" name="min_last_seen_days" value="{{ min_last_seen_days or '' }}" />
    <input type="hidden" name="exclude_contains" value="{{ exclude_contains or '' }}" />
    <input type="hidden" name="skip_bots" value="{{ 1 if (skip_bots is not defined or skip_bots) else 0 }}" />
    <input type="hidden" name="skip_admins" value="{{ 1 if (skip_admins is not defined or skip_admins) else 0 }}" />
    <button type="submit">Download CSV (detailed)</button>
  </form>
  <form method="post" action="/scrape/enqueue">
    <input type="hidden" name="csrf" value="{{ csrf }}" />
    <p><label>Destination
      <input type="text" name="dest" placeholder="@mygroup" required />
    </label></p>
    <textarea name="usernames">{% for u in results %}{{ u if u is string else u.username }}
{% endfor %}</textarea>
    <p>
      <label>Restrict to selected accounts:</label><br />
      {% for a in accounts %}
        <label><input type="checkbox" name="account_ids" value="{{ a.id }}" /> {{ a.phone }}</label><br />
      {% endfor %}
    </p>
    <div style="margin-top:1rem;"><button type="submit">Enqueue to Add</button></div>
  </form>
  {% endif %}
</body>
</html>
